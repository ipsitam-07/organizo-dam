events {
  worker_connections 1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # Logging 
  log_format main '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent '
                  '"$http_referer" "$http_user_agent" '
                  'rt=$request_time';

  access_log /var/log/nginx/access.log main;
  error_log  /var/log/nginx/error.log warn;

  # Performance 
  sendfile        on;
  keepalive_timeout 65;
  gzip on;
  gzip_types text/plain application/json application/javascript text/css;

  # Upstream services 
  upstream tus_server {
    server tus-server:1080;
    keepalive 16;
  }

  upstream auth_service {
    server api:3001;
    keepalive 16;
  }

  upstream upload_service {
    server api:3002;
    keepalive 16;
  }

  upstream asset_service {
    server api:3003;
    keepalive 16;
  }

  upstream web_frontend {
    server web:5173;
    keepalive 16;
  }

  server {
    listen 80;
    server_name localhost;

    # TUS
    location /uploads/ {
      proxy_pass         http://tus_server;
      proxy_http_version 1.1;

      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;

      proxy_request_buffering off;

      client_max_body_size 0;

      proxy_read_timeout    3600s;
      proxy_send_timeout    3600s;
      proxy_connect_timeout 60s;

      proxy_pass_request_headers on;
    }

    # Auth Service
    location /api/auth/ {
      proxy_pass         http://auth_service;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   Connection        "";
      client_max_body_size 1m;
    }

    # Upload Service
    location /api/upload/ {
      proxy_pass         http://upload_service;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   Connection        "";
      client_max_body_size 1m;
    }

    # Asset Service
    location /api/assets/ {
      proxy_pass         http://asset_service;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   Connection        "";
      client_max_body_size 1m;
    }

    # Health checks (per service)
    location /health/auth {
      proxy_pass http://auth_service/health;
      proxy_http_version 1.1;
    }

    location /health/upload {
      proxy_pass http://upload_service/health;
      proxy_http_version 1.1;
    }

    location /health/asset {
      proxy_pass http://asset_service/health;
      proxy_http_version 1.1;
    }

    location /health/tus {
      proxy_pass http://tus_server/health;
      proxy_http_version 1.1;
    }

    # Frontend
    location / {
      proxy_pass         http://web_frontend;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   Upgrade           $http_upgrade;
      proxy_set_header   Connection        "upgrade";
    }
  }
}
